<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Analysis - Skill Capital AI MockMate</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .analysis-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
        }
        .success-banner {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #c3e6cb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .success-banner h2 {
            color: #155724;
            margin-bottom: 8px;
            font-size: 22px;
        }
        .success-banner p {
            color: #155724;
            font-size: 14px;
        }
        .analysis-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px var(--shadow-sm);
        }
        .analysis-section {
            margin-bottom: 25px;
        }
        .analysis-section:last-child {
            margin-bottom: 0;
        }
        .analysis-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-light);
        }
        .info-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 150px;
        }
        .info-value {
            color: var(--text-primary);
            flex: 1;
        }
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }
        .spinner-large {
            width: 60px;
            height: 60px;
            border: 5px solid var(--border-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        .error-state {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            color: #721c24;
        }
        .error-state h3 {
            color: #721c24;
            margin-bottom: 10px;
        }
        .back-button {
            margin-top: 30px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <img src="logo.png" alt="Skill Capital AI MockMate Logo" class="header-logo">
                <div class="header-text">
                    <h1>Resume Analysis</h1>
                    <p class="subtitle">Your resume has been processed</p>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="analysis-container">
                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <div class="spinner-large"></div>
                    <h2 style="color: var(--text-secondary); margin-bottom: 10px;">Analyzing Your Resume...</h2>
                    <p style="color: var(--text-light);">Please wait while we extract information from your resume.</p>
                </div>

                <!-- Success State -->
                <div id="successState" class="hidden">
                    <div class="success-banner">
                        <h2>‚úì Your resume has been successfully analyzed!</h2>
                        <p>We've extracted the following information from your resume.</p>
                    </div>

                    <div class="analysis-card">
                        <div class="analysis-section">
                            <h3>üìã Personal Information</h3>
                            <div class="info-row">
                                <span class="info-label">Name:</span>
                                <span class="info-value" id="resumeName">Not found</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value" id="resumeEmail">Not found</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Experience Level:</span>
                                <span class="info-value" id="resumeExperience">Not found</span>
                            </div>
                            <div id="experienceInputContainer" class="hidden" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                <p style="color: #856404; margin-bottom: 10px; font-size: 14px;">
                                    <strong>Experience not found in resume.</strong> Please enter your experience manually.
                                </p>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input 
                                        type="text" 
                                        id="experienceInput" 
                                        placeholder="e.g., 2 years, Fresher, 5+ years"
                                        style="flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;"
                                    >
                                    <button 
                                        id="saveExperienceBtn" 
                                        class="btn btn-primary"
                                        style="padding: 10px 20px; font-size: 14px;"
                                    >
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <h3>üíº Skills Extracted</h3>
                            <div id="resumeSkills" class="skills-list"></div>
                        </div>

                        <div class="analysis-section">
                            <h3>üìä Enhanced Summary</h3>
                            
                            <!-- Resume Summary Paragraph -->
                            <div id="resumeSummaryContainer" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #64B5F6;">
                                <h4 style="font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">Clear Resume Summary</h4>
                                <p id="resumeSummary" style="color: var(--text-primary); line-height: 1.6; margin: 0;">Loading...</p>
                            </div>
                            
                            <!-- Skills Summary by Category -->
                            <div id="skillsSummaryContainer" style="margin-bottom: 20px;">
                                <h4 style="font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 15px;">Extracted Skills Summary</h4>
                                <div id="skillsSummary" style="display: grid; gap: 15px;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Projects Summary -->
                            <div id="projectsSummaryContainer" style="margin-bottom: 20px;">
                                <h4 style="font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 15px;">Projects Summary</h4>
                                <div id="projectsSummary" style="display: grid; gap: 12px;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Insights -->
                            <div id="insightsContainer" style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #64B5F6;">
                                <h4 style="font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px;">Key Insights</h4>
                                <div id="insights" style="font-size: 14px; color: var(--text-primary); line-height: 1.6;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Interview Modules Overview Section -->
                        <div class="analysis-section">
                            <h3>üéØ Interview Modules Overview</h3>
                            
                            <div id="interviewModulesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;">
                                <!-- Technical Interview Module -->
                                <div class="module-card" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; border-left: 4px solid #2196F3;">
                                    <h4 style="font-size: 18px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span>üíª</span> Technical Interview
                                    </h4>
                                    <p id="technicalDescription" style="font-size: 14px; color: var(--text-primary); line-height: 1.6; margin-bottom: 15px;">Loading...</p>
                                    <div style="margin-top: 15px;">
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">Core Technical & Domain Skills:</div>
                                        <div id="technicalTopics" class="skills-list"></div>
                                    </div>
                                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        <button class="btn btn-primary" onclick="startInterviewFromModule('technical')" style="width: 100%; padding: 10px; font-size: 14px;">Start Interview</button>
                                    </div>
                                </div>

                                <!-- Coding / Online Test Module -->
                                <div class="module-card" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; border-left: 4px solid #4CAF50;">
                                    <h4 style="font-size: 18px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span>‚å®Ô∏è</span> Coding / Online Test
                                    </h4>
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 6px;">Difficulty Level:</div>
                                        <div id="codingDifficulty" style="display: inline-block; padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border-radius: 6px; font-weight: 600; font-size: 13px;">‚Äî</div>
                                    </div>
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">Recommended Platforms:</div>
                                        <div id="codingPlatforms" class="skills-list"></div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">Programming & DSA Topics:</div>
                                        <div id="codingTopics" class="skills-list"></div>
                                    </div>
                                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        <button class="btn btn-primary" onclick="startInterviewFromModule('coding')" style="width: 100%; padding: 10px; font-size: 14px;">Start Interview</button>
                                    </div>
                                </div>

                                <!-- HR Interview Module -->
                                <div class="module-card" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; border-left: 4px solid #FF9800;">
                                    <h4 style="font-size: 18px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span>üëî</span> HR Interview
                                    </h4>
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">Evaluation Points:</div>
                                        <ul id="hrEvaluationPoints" style="font-size: 13px; color: var(--text-primary); line-height: 1.8; margin: 0; padding-left: 20px;">
                                            <li>Loading...</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">Communication & Leadership Skills:</div>
                                        <ul id="hrSuggestions" style="font-size: 13px; color: var(--text-primary); line-height: 1.8; margin: 0; padding-left: 20px;">
                                            <li>Loading...</li>
                                        </ul>
                                    </div>
                                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        <button class="btn btn-primary" onclick="startInterviewFromModule('hr')" style="width: 100%; padding: 10px; font-size: 14px;">Start Interview</button>
                                    </div>
                                </div>

                                <!-- Behavioral Interview Module -->
                                <div class="module-card" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; border-left: 4px solid #9C27B0;">
                                    <h4 style="font-size: 18px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span>üåü</span> Behavioral Interview
                                    </h4>
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">STAR Method:</div>
                                        <div id="starGuidance" style="font-size: 13px; color: var(--text-primary); line-height: 1.6;">
                                            <div style="margin-bottom: 8px;"><strong>S:</strong> <span id="starSituation">‚Äî</span></div>
                                            <div style="margin-bottom: 8px;"><strong>T:</strong> <span id="starTask">‚Äî</span></div>
                                            <div style="margin-bottom: 8px;"><strong>A:</strong> <span id="starAction">‚Äî</span></div>
                                            <div><strong>R:</strong> <span id="starResult">‚Äî</span></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">STAR Method Points from Resume:</div>
                                        <ul id="behavioralTips" style="font-size: 13px; color: var(--text-primary); line-height: 1.8; margin: 0; padding-left: 20px;">
                                            <li>Loading...</li>
                                        </ul>
                                    </div>
                                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        <button class="btn btn-primary" onclick="startInterviewFromModule('behavioral')" style="width: 100%; padding: 10px; font-size: 14px;">Start Interview</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden">
                    <div class="error-state">
                        <h3>‚ö†Ô∏è Resume Analysis Failed</h3>
                        <p id="errorMessage">An error occurred while processing your resume. Please try again.</p>
                        <p style="margin-top: 15px; font-size: 14px; color: #666;">
                            <strong>Tips:</strong><br>
                            ‚Ä¢ Ensure your file is a valid PDF or DOCX document<br>
                            ‚Ä¢ For LaTeX-generated PDFs (from Overleaf): Install Tesseract OCR or export as PDF/A<br>
                            ‚Ä¢ Make sure the file contains selectable text (not just images)<br>
                            ‚Ä¢ Check that the file is not corrupted or password-protected<br>
                            ‚Ä¢ Try uploading a different file format or re-exporting your resume
                        </p>
                    </div>
                </div>

                <div class="back-button">
                    <button class="btn btn-primary" onclick="window.location.href='/'">Back to Dashboard</button>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2026 Skill Capital AI MockMate</p>
        </footer>
    </div>

    <!-- Load API configuration first -->
    <script src="api-config.js"></script>
    <script>
        // Get resume data from URL parameters or sessionStorage
        async function loadResumeAnalysis() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session') || sessionStorage.getItem('resume_analysis_session');
            
            // Try to get from sessionStorage first (faster)
            const cachedData = sessionStorage.getItem('resume_analysis_data');
            if (cachedData) {
                try {
                    const data = JSON.parse(cachedData);
                    // Check if it's an error state
                    if (data.success === false && data.error) {
                        showError(data.error || 'Failed to parse resume. Please try again with another file.');
                        return;
                    }
                    // Display success data
                    displayAnalysis(data);
                    return;
                } catch (e) {
                    // Failed to parse cached data, fetching from server
                }
            }
            
            if (!sessionId || sessionId === 'new') {
                showError('No resume analysis data found. Please upload a resume first.');
                return;
            }

            try {
                // Check if session_id starts with "error_" - this means it's an error session
                if (sessionId && sessionId.startsWith('error_')) {
                    if (cachedData) {
                        try {
                            const data = JSON.parse(cachedData);
                            if (data.success === false && data.error) {
                                showError(data.error || 'Failed to parse resume. Please try again with another file.');
                                return;
                            }
                            displayAnalysis(data);
                            return;
                        } catch (parseError) {
                            console.error('Failed to parse cached error data:', parseError);
                            showError('Failed to parse resume. Please try uploading again.');
                            return;
                        }
                    } else {
                        showError('No resume analysis data found. Please upload a resume first.');
                        return;
                    }
                }
                
                // Fetch analysis data from backend
                const res = await fetch(`${getApiBase()}/api/profile/resume-analysis/${sessionId}`);
                
                if (!res.ok) {
                    // If 404 and we have cached data, use it
                    if (res.status === 404 && cachedData) {
                        try {
                            const data = JSON.parse(cachedData);
                            if (data.success === false && data.error) {
                                showError(data.error || 'Failed to parse resume. Please try again with another file.');
                                return;
                            }
                            displayAnalysis(data);
                            return;
                        } catch (parseError) {
                            console.error('Failed to parse cached data:', parseError);
                            showError('Session expired. Please upload your resume again.');
                            return;
                        }
                    }
                    // For other errors, try to get error message from response
                    let errorMessage = 'Failed to fetch analysis data';
                    try {
                        const errorData = await res.json();
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = `Server error: ${res.status} ${res.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await res.json();
                
                // Check for error state
                if (data.success === false && data.error) {
                    showError(data.error || 'Failed to parse resume. Please try again with another file.');
                    return;
                }
                
                displayAnalysis(data);
            } catch (e) {
                console.error('Error loading analysis:', e);
                // Try sessionStorage as fallback
                if (cachedData) {
                    try {
                        const data = JSON.parse(cachedData);
                        if (data.success === false && data.error) {
                            showError(data.error || 'Failed to parse resume. Please try again with another file.');
                            return;
                        }
                        displayAnalysis(data);
                        return;
                    } catch (parseError) {
                        console.error('Failed to parse cached data:', parseError);
                    }
                }
                // Show the actual error message if available
                let errorMsg = e.message || 'Failed to load resume analysis.';
                
                // Provide more helpful error messages
                if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                    errorMsg = 'Network error: Could not connect to the server. Please check your internet connection and try again.';
                } else if (errorMsg.includes('404')) {
                    errorMsg = 'Session expired or not found. Please upload your resume again.';
                } else if (errorMsg.includes('500')) {
                    errorMsg = 'Server error occurred. Please try again in a moment.';
                }
                
                showError(errorMsg);
            }
        }

        function displayAnalysis(data) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('successState').classList.remove('hidden');

            // Display personal information
            document.getElementById('resumeName').textContent = data.name || 'Not found';
            document.getElementById('resumeEmail').textContent = data.email || 'Not found';
            
            // Handle experience display and manual input
            const experience = data.experience_level || data.experience || 'Not found';
            const experienceElement = document.getElementById('resumeExperience');
            const experienceInputContainer = document.getElementById('experienceInputContainer');
            
            // Check if experience is missing or not specified
            const isExperienceMissing = !experience || 
                                       experience === 'Not found' || 
                                       experience === 'Not specified' || 
                                       experience === 'Unknown' ||
                                       experience.trim() === '';
            
            if (isExperienceMissing) {
                experienceElement.textContent = 'Not found';
                experienceInputContainer.classList.remove('hidden');
            } else {
                experienceElement.textContent = experience;
                experienceInputContainer.classList.add('hidden');
            }

            // Display skills
            const skills = data.skills || [];
            const skillsContainer = document.getElementById('resumeSkills');
            if (skills.length > 0) {
                skillsContainer.innerHTML = skills.map(s => `<span class="skill-tag">${s}</span>`).join('');
            } else {
                skillsContainer.innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px;">No skills detected</p>';
            }

            // Display enhanced summary
            const summary = data.summary || {};
            
            // Display resume summary paragraph
            const resumeSummary = summary.resume_summary || 'Summary not available.';
            document.getElementById('resumeSummary').textContent = resumeSummary;
            
            // Display categorized skills
            const skillsSummary = summary.skills_summary || {};
            const skillsSummaryContainer = document.getElementById('skillsSummary');
            const categories = ['Programming', 'AI/ML', 'Tools', 'Soft Skills'];
            let skillsSummaryHtml = '';
            
            categories.forEach(category => {
                const categorySkills = skillsSummary[category] || [];
                if (categorySkills.length > 0) {
                    skillsSummaryHtml += `
                        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #64B5F6;">
                            <div style="font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">${category}</div>
                            <div class="skills-list">
                                ${categorySkills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (skillsSummaryHtml) {
                skillsSummaryContainer.innerHTML = skillsSummaryHtml;
            } else {
                skillsSummaryContainer.innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px;">No categorized skills available.</p>';
            }
            
            // Display projects summary
            const projects = summary.projects_summary || [];
            const projectsContainer = document.getElementById('projectsSummary');
            if (projects.length > 0) {
                projectsContainer.innerHTML = projects.map(project => `
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #4CAF50;">
                        <div style="font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">${project.name || 'Untitled Project'}</div>
                        <div style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">
                            ${project.summary || 'No description available.'}
                        </div>
                    </div>
                `).join('');
            } else {
                projectsContainer.innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px;">No projects detected in resume.</p>';
            }
            
            // Display insights
            const insights = generateInsights(data, summary);
            document.getElementById('insights').innerHTML = insights;
            
            // Display Interview Modules Overview
            const interviewModules = data.interview_modules || {};
            
            // Technical Interview Module
            const technicalInterview = interviewModules.technical_interview || {};
            document.getElementById('technicalDescription').textContent = technicalInterview.description || 'Prepare for technical questions covering your core skills and technologies.';
            const technicalSkills = technicalInterview.skills || [];
            const technicalTopicsContainer = document.getElementById('technicalTopics');
            if (technicalSkills.length > 0) {
                technicalTopicsContainer.innerHTML = technicalSkills.map(skill => `<span class="skill-tag">${skill}</span>`).join('');
            } else {
                technicalTopicsContainer.innerHTML = '<p style="color: #999; font-size: 12px;">No technical skills found</p>';
            }
            
            // Coding / Online Test Module
            const codingTest = interviewModules.coding_test || {};
            document.getElementById('codingDifficulty').textContent = codingTest.difficulty_level || '‚Äî';
            const codingPlatforms = codingTest.platforms || [];
            const codingPlatformsContainer = document.getElementById('codingPlatforms');
            if (codingPlatforms.length > 0) {
                codingPlatformsContainer.innerHTML = codingPlatforms.map(platform => `<span class="skill-tag">${platform}</span>`).join('');
            } else {
                codingPlatformsContainer.innerHTML = '<p style="color: #999; font-size: 12px;">No platforms available</p>';
            }
            const codingTopics = codingTest.topics || [];
            const codingTopicsContainer = document.getElementById('codingTopics');
            if (codingTopics.length > 0) {
                codingTopicsContainer.innerHTML = codingTopics.map(topic => `<span class="skill-tag">${topic}</span>`).join('');
            } else {
                codingTopicsContainer.innerHTML = '<p style="color: #999; font-size: 12px;">No topics available</p>';
            }
            
            // HR Interview Module
            const hrInterview = interviewModules.hr_interview || {};
            const hrEvaluationPoints = hrInterview.evaluation_points || [];
            const hrEvaluationPointsContainer = document.getElementById('hrEvaluationPoints');
            if (hrEvaluationPoints.length > 0) {
                hrEvaluationPointsContainer.innerHTML = hrEvaluationPoints.map(point => `<li>${point}</li>`).join('');
            } else {
                hrEvaluationPointsContainer.innerHTML = '<li style="color: #999;">No evaluation points available</li>';
            }
            const hrSkills = hrInterview.skills || [];
            const hrSuggestionsContainer = document.getElementById('hrSuggestions');
            if (hrSkills.length > 0) {
                hrSuggestionsContainer.innerHTML = hrSkills.map(skill => `<li>${skill}</li>`).join('');
            } else {
                hrSuggestionsContainer.innerHTML = '<li style="color: #999;">No skills found</li>';
            }
            
            // Behavioral Interview Module
            const behavioralInterview = interviewModules.behavioral_interview || {};
            const starGuidance = behavioralInterview.star_guidance || {};
            document.getElementById('starSituation').textContent = starGuidance.Situation || '‚Äî';
            document.getElementById('starTask').textContent = starGuidance.Task || '‚Äî';
            document.getElementById('starAction').textContent = starGuidance.Action || '‚Äî';
            document.getElementById('starResult').textContent = starGuidance.Result || '‚Äî';
            const starPoints = behavioralInterview.star_points || [];
            const behavioralTipsContainer = document.getElementById('behavioralTips');
            if (starPoints.length > 0) {
                behavioralTipsContainer.innerHTML = starPoints.map(point => `<li>${point}</li>`).join('');
            } else {
                behavioralTipsContainer.innerHTML = '<li style="color: #999;">No STAR points extracted</li>';
            }
        }

        function generateInsights(data, summary) {
            const insights = [];
            const skills = data.skills || [];
            const projects = summary.projects_summary || [];
            const experience = data.experience_level || 'Not specified';
            const rating = summary.resume_rating || 0;
            
            // Skills insight
            if (skills.length > 0) {
                insights.push(`<strong>Skills:</strong> ${skills.length} technical skills identified, showing ${skills.length >= 10 ? 'strong' : 'moderate'} technical breadth.`);
            }
            
            // Projects insight
            if (projects.length > 0) {
                insights.push(`<strong>Projects:</strong> ${projects.length} project${projects.length > 1 ? 's' : ''} detected, demonstrating practical experience and problem-solving ability.`);
            } else {
                insights.push(`<strong>Projects:</strong> Consider adding project details to showcase your hands-on experience.`);
            }
            
            // Experience insight
            if (experience && experience !== 'Not specified' && experience !== 'Unknown') {
                insights.push(`<strong>Experience:</strong> ${experience} of professional experience, indicating ${experience.includes('Fresher') || experience.includes('1') ? 'entry-level' : 'experienced'} candidate profile.`);
            }
            
            // Rating insight
            if (rating >= 4.0) {
                insights.push(`<strong>Resume Quality:</strong> Strong resume (${rating.toFixed(2)}/5.0) with good structure, skills, and completeness.`);
            } else if (rating >= 3.0) {
                insights.push(`<strong>Resume Quality:</strong> Good resume (${rating.toFixed(2)}/5.0) with room for improvement in formatting or detail.`);
            } else {
                insights.push(`<strong>Resume Quality:</strong> Resume needs enhancement (${rating.toFixed(2)}/5.0). Consider adding more skills, projects, or experience details.`);
            }
            
            return insights.map(insight => `<div style="margin-bottom: 8px;">${insight}</div>`).join('');
        }

        // Make function globally accessible - define it early to ensure it's available
        function startInterviewFromModule(moduleType) {
            // Normalize module type (trim and lowercase for safety)
            const normalizedType = String(moduleType || '').trim().toLowerCase();
            
            // Store the module type in sessionStorage for reference
            sessionStorage.setItem('selectedInterviewModule', normalizedType);
            
            // Redirect to appropriate interview page using switch for better reliability
            let targetUrl = null;
            
            switch(normalizedType) {
                case 'technical':
                    targetUrl = 'interview.html';
                    break;
                case 'coding':
                    targetUrl = 'coding-interview.html';
                    break;
                case 'hr':
                    targetUrl = 'hr-interview.html';
                    break;
                case 'behavioral':
                case 'star':
                    targetUrl = 'star-interview.html';
                    break;
                default:
                    targetUrl = 'index.html';
                    break;
            }
            
            // Perform navigation
            if (targetUrl) {
                window.location.href = targetUrl;
            }
            
            return false; // Prevent default behavior
        }
        
        // Also attach to window for extra safety
        window.startInterviewFromModule = startInterviewFromModule;

        // Handle manual experience input
        async function saveExperience() {
            const experienceInput = document.getElementById('experienceInput');
            const experience = experienceInput.value.trim();
            
            if (!experience) {
                alert('Please enter your experience level.');
                return;
            }
            
            // Get session ID from URL or sessionStorage
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session') || sessionStorage.getItem('resume_analysis_session');
            
            if (!sessionId) {
                alert('Session not found. Please refresh the page and try again.');
                return;
            }
            
            try {
                // Get user_id from localStorage (persistent) or sessionStorage
                let userId = localStorage.getItem('user_id') || sessionStorage.getItem('resume_user_id');
                if (!userId) {
                    try {
                        const userRes = await fetch(`${getApiBase()}/api/profile/current`);
                        if (userRes.ok) {
                            const user = await userRes.json();
                            userId = user.user_id;
                            // Store in localStorage for persistence
                            if (userId) {
                                localStorage.setItem('user_id', userId);
                                sessionStorage.setItem('resume_user_id', userId);
                            }
                        }
                    } catch (e) {
                        // Could not get current user
                    }
                }
                
                // Build URL with experience and optional user_id
                let url = `${getApiBase()}/api/profile/resume-analysis/${sessionId}/experience?experience=${encodeURIComponent(experience)}`;
                if (userId) {
                    url += `&user_id=${encodeURIComponent(userId)}`;
                }
                
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage = 'Failed to update experience';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    console.error('[EXPERIENCE_UPDATE] Error response:', errorMessage);
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                
                // Verify success
                if (result.status === 'success' || result.success === true) {
                    // Update the display immediately
                    document.getElementById('resumeExperience').textContent = experience;
                    document.getElementById('experienceInputContainer').classList.add('hidden');
                    
                    // Update cached data in sessionStorage
                    const cachedData = sessionStorage.getItem('resume_analysis_data');
                    if (cachedData) {
                        const data = JSON.parse(cachedData);
                        data.experience_level = experience;
                        sessionStorage.setItem('resume_analysis_data', JSON.stringify(data));
                    }
                    
                    // Show success message briefly
                    const saveBtn = document.getElementById('saveExperienceBtn');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = 'Saved!';
                    saveBtn.style.background = '#28a745';
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.style.background = '';
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('[EXPERIENCE_UPDATE] Error saving experience:', error);
                console.error('[EXPERIENCE_UPDATE] Error details:', error.message);
                alert(`Failed to save experience: ${error.message || 'Please try again.'}`);
            }
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Load analysis on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadResumeAnalysis();
            
            // Setup experience input handlers (already handled above, but ensure they're set)
            const saveBtn = document.getElementById('saveExperienceBtn');
            const experienceInput = document.getElementById('experienceInput');
            
            if (saveBtn) {
                saveBtn.addEventListener('click', saveExperience);
            }
            
            if (experienceInput) {
                experienceInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveExperience();
                    }
                });
            }
        });
    </script>
</body>
</html>

