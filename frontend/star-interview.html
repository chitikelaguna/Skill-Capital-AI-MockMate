<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAR Interview - Skill Capital AI MockMate</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .interview-page-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .interview-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .interview-header h1 {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .interview-status {
            display: inline-block;
            padding: 8px 16px;
            background: var(--accent-light);
            border-radius: 20px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .interview-status.active {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .interview-status.completed {
            background: #bbdefb;
            color: #1565c0;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
        }

        .voice-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(142, 197, 252, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(142, 197, 252, 0.6);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #ef5350 0%, #c62828 100%);
            animation: pulse 1.5s infinite;
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .voice-status {
            text-align: center;
            color: var(--text-light);
            font-size: 14px;
            margin-top: 10px;
        }

        .conversation-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 2px 8px var(--shadow-sm);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.ai {
            background: var(--accent-light);
            border-left: 4px solid var(--primary);
        }

        .message.user {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-left: auto;
            max-width: 80%;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .message-content {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .audio-player {
            margin-top: 10px;
            width: 100%;
        }

        .interview-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-light);
        }

        .btn-danger {
            background: #ef5350;
            color: white;
        }

        .btn-danger:hover {
            background: #c62828;
        }

        /* STAR Result Page - Modern User-Friendly Design */
        .feedback-section {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 0;
            margin-top: 30px;
            box-shadow: 0 4px 20px var(--shadow-md);
            overflow: hidden;
        }

        .feedback-header {
            background: linear-gradient(135deg, #fafbfc 0%, #f5f7fa 100%);
            padding: 40px 30px;
            text-align: center;
            border-bottom: 2px solid var(--border-light);
        }

        .feedback-header h2 {
            color: var(--text-secondary);
            margin: 0 0 12px 0;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .feedback-header p {
            color: var(--text-light);
            margin: 0;
            font-size: 16px;
            font-weight: 400;
        }

        .feedback-content-wrapper {
            padding: 40px 30px;
        }

        /* Score Section - Centered Modern Card */
        .score-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 20px;
            border: 2px solid var(--border-light);
            box-shadow: 0 4px 16px var(--shadow-sm);
        }

        .score-label {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 16px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .score-value {
            font-size: 72px;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 0;
            line-height: 1;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-out-of {
            font-size: 18px;
            color: var(--text-light);
            margin-top: 12px;
            font-weight: 400;
        }

        .score-badge {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--accent-light) 0%, #f3e5f5 100%);
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            border: 1px solid var(--accent);
            box-shadow: 0 2px 8px var(--shadow-sm);
        }

        .score-message {
            margin-top: 16px;
            font-size: 16px;
            color: var(--text-light);
            font-style: italic;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 24px;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%);
            border-radius: 16px;
            border-left: 4px solid var(--primary);
        }

        .welcome-message p {
            margin: 0;
            font-size: 18px;
            color: var(--text-secondary);
            font-weight: 500;
            line-height: 1.6;
        }

        /* Participation Stats */
        .participation-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fafbfc 0%, #f5f7fa 100%);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        .stat-item .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }

        .stat-item .stat-label {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .participation-note {
            margin-top: 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            border-left: 3px solid #4caf50;
        }

        /* Performance Breakdown */
        .performance-intro {
            margin-bottom: 24px;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
        }

        .performance-breakdown {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .performance-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .performance-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .performance-icon {
            font-size: 20px;
        }

        .performance-bar-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .performance-bar {
            flex: 1;
            height: 12px;
            background: var(--border-light);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .performance-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            transition: width 0.8s ease;
            box-shadow: 0 2px 8px rgba(142, 197, 252, 0.4);
        }

        .performance-score {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 45px;
            text-align: right;
        }

        .section-intro {
            margin-bottom: 16px;
            color: var(--text-light);
            font-size: 14px;
            font-style: italic;
        }

        /* Feedback Cards - Modern Card Style */
        .feedback-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1.5px solid var(--border-light);
            box-shadow: 0 2px 12px var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .feedback-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--shadow-md);
            border-color: var(--primary);
        }

        .feedback-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-light);
        }

        .feedback-card-icon {
            font-size: 28px;
            line-height: 1;
        }

        .feedback-card-title {
            color: var(--text-secondary);
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .feedback-card-content {
            color: var(--text-primary);
        }

        /* Strengths Section - Motivational Style */
        .strengths-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .strengths-list li {
            padding: 14px 16px 14px 48px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-radius: 12px;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            border-left: 4px solid #4caf50;
            box-shadow: 0 1px 4px var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .strengths-list li:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px var(--shadow-sm);
        }

        .strengths-list li:before {
            content: "‚úÖ";
            position: absolute;
            left: 16px;
            top: 14px;
            font-size: 18px;
        }

        /* Areas for Improvement - Soft Warning Style */
        .improvements-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .improvements-list li {
            padding: 14px 16px 14px 48px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #fff3e0 0%, #fff8e1 100%);
            border-radius: 12px;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            border-left: 4px solid #ff9800;
            box-shadow: 0 1px 4px var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .improvements-list li:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px var(--shadow-sm);
        }

        .improvements-list li:before {
            content: "‚ö†Ô∏è";
            position: absolute;
            left: 16px;
            top: 14px;
            font-size: 18px;
        }

        /* Recommendations - Check-list Style */
        .recommendations-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .recommendations-list li {
            padding: 14px 16px 14px 48px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%);
            border-radius: 12px;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            border-left: 4px solid #2196f3;
            box-shadow: 0 1px 4px var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .recommendations-list li:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px var(--shadow-sm);
        }

        .recommendations-list li:before {
            content: "üí°";
            position: absolute;
            left: 16px;
            top: 14px;
            font-size: 18px;
        }

        /* Summary Section - Paragraph Format */
        .summary-content {
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #fafbfc 0%, #f5f7fa 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 1px 4px var(--shadow-sm);
        }

        .summary-content p {
            margin: 0;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
        }

        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #c62828;
        }

        /* Interview Guidelines Section */
        .guidelines-section {
            background: linear-gradient(135deg, #fafbfc 0%, #f5f7fa 100%);
            border-radius: 16px;
            padding: 28px;
            margin: 30px 0;
            border: 1.5px solid var(--border-light);
            box-shadow: 0 2px 12px var(--shadow-sm);
        }

        .guidelines-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-light);
        }

        .guidelines-header h3 {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
            letter-spacing: -0.3px;
        }

        .guidelines-header-icon {
            font-size: 28px;
        }

        .guideline-category {
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 1px 4px var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .guideline-category:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px var(--shadow-md);
        }

        .guideline-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .guideline-category-header h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
            letter-spacing: -0.2px;
        }

        .guideline-category-icon {
            font-size: 20px;
        }

        .guideline-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .guideline-list li {
            padding: 10px 0 10px 28px;
            color: var(--text-primary);
            line-height: 1.7;
            position: relative;
            font-size: 15px;
        }

        .guideline-list li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
            font-size: 18px;
        }

        .guideline-list li:not(:last-child) {
            border-bottom: 1px solid var(--border-light);
        }

        /* Modern Modal Styles - Matching Technical Interview */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-message {
            font-size: 16px;
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-light);
        }

        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }

        .modal-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-btn-cancel:hover {
            background: var(--border-light);
        }

        .modal-btn-confirm {
            background: var(--primary);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: var(--primary-hover);
        }

        @media (max-width: 600px) {
            .modal-container {
                width: 95%;
                margin: 20px;
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 20px;
            }

            .modal-footer {
                flex-direction: column-reverse;
            }

            .modal-btn {
                width: 100%;
            }

            /* Responsive STAR Result Page */
            .feedback-header {
                padding: 30px 20px;
            }

            .feedback-header h2 {
                font-size: 24px;
            }

            .feedback-header p {
                font-size: 14px;
            }

            .feedback-content-wrapper {
                padding: 24px 16px;
            }

            .score-section {
                padding: 30px 20px;
            }

            .score-value {
                font-size: 56px;
            }

            .score-badge {
                font-size: 14px;
                padding: 8px 20px;
            }

            .feedback-card {
                padding: 20px;
            }

            .feedback-card-title {
                font-size: 20px;
            }

            .strengths-list li,
            .improvements-list li,
            .recommendations-list li {
                padding: 12px 12px 12px 44px;
                font-size: 14px;
            }

            .summary-content {
                padding: 16px;
                font-size: 15px;
            }

            .participation-stats {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .stat-item .stat-value {
                font-size: 28px;
            }

            .welcome-message {
                padding: 20px 16px;
            }

            .welcome-message p {
                font-size: 16px;
            }

            .performance-breakdown {
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <img src="logo.png" alt="Skill Capital AI MockMate Logo" class="header-logo">
                <div class="header-text">
                    <h1>STAR Interview</h1>
                    <p class="subtitle">AI-Powered Behavioral Interview Experience</p>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="interview-page-container">
                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <div class="spinner"></div>
                    <h2 style="color: var(--text-secondary);">Initializing Interview...</h2>
                    <p style="color: var(--text-light);">Please wait while we prepare your interview questions.</p>
                </div>

                <!-- Interview Interface (Chat-Based Flow) -->
                <div id="interviewInterface" class="hidden">
                    <!-- Interview Status -->
                    <div class="interview-header">
                        <div class="interview-status" id="interviewStatus">Ready to Start</div>
                    </div>

                    <!-- Conversation Display (Chat-Based) -->
                    <div class="conversation-container" id="conversationContainer">
                        <div class="loading" id="loadingMessage">Initializing interview...</div>
                    </div>

                    <!-- Voice Controls -->
                    <div class="voice-controls">
                        <button class="voice-button" id="voiceButton" title="Click to record your answer">
                            üé§
                        </button>
                        <div class="voice-status" id="voiceStatus">Click the microphone to start recording</div>
                    </div>

                    <!-- Interview Actions -->
                    <div class="interview-actions">
                        <button class="btn btn-danger" id="endInterviewBtn">End Interview</button>
                    </div>
                </div>

                <!-- Feedback Section (Hidden until interview ends) -->
                <div id="feedbackSection" class="feedback-section hidden">
                    <!-- Clean Header -->
                    <div class="feedback-header">
                        <h2>Your STAR Interview Results</h2>
                        <p>Here is a personalized breakdown of your interview performance.</p>
                    </div>

                    <div class="loading" id="feedbackLoading">Generating your personalized feedback...</div>
                    <div id="feedbackContent" class="hidden">
                        <div class="feedback-content-wrapper">
                            <!-- Personal Welcome Message -->
                            <div class="welcome-message">
                                <p id="welcomeText">Great job completing your STAR interview! Here's your personalized performance report.</p>
                            </div>

                            <!-- Score Section - Centered, Modern Card -->
                            <div class="score-section">
                                <div class="score-label">Your Overall Performance</div>
                                <div class="score-value" id="overallScore">0</div>
                                <div class="score-out-of">out of 100</div>
                                <div class="score-badge" id="scoreBadge">‚≠ê Beginner</div>
                                <div class="score-message" id="scoreMessage">Keep practicing to improve your STAR responses!</div>
                            </div>

                            <!-- Interview Participation Section -->
                            <div class="feedback-card participation-card">
                                <div class="feedback-card-header">
                                    <span class="feedback-card-icon">üìä</span>
                                    <h3 class="feedback-card-title">Your Interview Participation</h3>
                                </div>
                                <div class="feedback-card-content">
                                    <div class="participation-stats">
                                        <div class="stat-item">
                                            <div class="stat-value" id="questionsAnswered">0</div>
                                            <div class="stat-label">Questions Answered</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="participationRate">0%</div>
                                            <div class="stat-label">Participation Rate</div>
                                        </div>
                                    </div>
                                    <p class="participation-note" id="participationNote">You actively engaged throughout the interview.</p>
                                </div>
                            </div>

                            <!-- Performance Breakdown Section -->
                            <div class="feedback-card performance-card">
                                <div class="feedback-card-header">
                                    <span class="feedback-card-icon">üìà</span>
                                    <h3 class="feedback-card-title">How Well You Answered</h3>
                                </div>
                                <div class="feedback-card-content">
                                    <p class="performance-intro">Here's how you performed across different STAR components:</p>
                                    <div class="performance-breakdown">
                                        <div class="performance-item">
                                            <div class="performance-label">
                                                <span class="performance-icon">üìç</span>
                                                <span>Situation</span>
                                            </div>
                                            <div class="performance-bar-container">
                                                <div class="performance-bar" id="situationBar">
                                                    <div class="performance-bar-fill" id="situationFill" style="width: 0%"></div>
                                                </div>
                                                <span class="performance-score" id="situationScore">0</span>
                                            </div>
                                        </div>
                                        <div class="performance-item">
                                            <div class="performance-label">
                                                <span class="performance-icon">üéØ</span>
                                                <span>Task</span>
                                            </div>
                                            <div class="performance-bar-container">
                                                <div class="performance-bar" id="taskBar">
                                                    <div class="performance-bar-fill" id="taskFill" style="width: 0%"></div>
                                                </div>
                                                <span class="performance-score" id="taskScore">0</span>
                                            </div>
                                        </div>
                                        <div class="performance-item">
                                            <div class="performance-label">
                                                <span class="performance-icon">‚ö°</span>
                                                <span>Action</span>
                                            </div>
                                            <div class="performance-bar-container">
                                                <div class="performance-bar" id="actionBar">
                                                    <div class="performance-bar-fill" id="actionFill" style="width: 0%"></div>
                                                </div>
                                                <span class="performance-score" id="actionScore">0</span>
                                            </div>
                                        </div>
                                        <div class="performance-item">
                                            <div class="performance-label">
                                                <span class="performance-icon">üèÜ</span>
                                                <span>Result</span>
                                            </div>
                                            <div class="performance-bar-container">
                                                <div class="performance-bar" id="resultBar">
                                                    <div class="performance-bar-fill" id="resultFill" style="width: 0%"></div>
                                                </div>
                                                <span class="performance-score" id="resultScore">0</span>
                                            </div>
                                        </div>
                                        <div class="performance-item">
                                            <div class="performance-label">
                                                <span class="performance-icon">‚≠ê</span>
                                                <span>STAR Structure</span>
                                            </div>
                                            <div class="performance-bar-container">
                                                <div class="performance-bar" id="structureBar">
                                                    <div class="performance-bar-fill" id="structureFill" style="width: 0%"></div>
                                                </div>
                                                <span class="performance-score" id="structureScore">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Strengths Section -->
                            <div class="feedback-card">
                                <div class="feedback-card-header">
                                    <span class="feedback-card-icon">‚úÖ</span>
                                    <h3 class="feedback-card-title">What You Did Well</h3>
                                </div>
                                <div class="feedback-card-content">
                                    <p class="section-intro">These are your key strengths from this interview:</p>
                                    <ul class="strengths-list" id="strengthsList"></ul>
                                </div>
                            </div>

                            <!-- Areas for Improvement Section -->
                            <div class="feedback-card">
                                <div class="feedback-card-header">
                                    <span class="feedback-card-icon">‚ö†Ô∏è</span>
                                    <h3 class="feedback-card-title">Areas You Can Improve</h3>
                                </div>
                                <div class="feedback-card-content">
                                    <p class="section-intro">Focus on these areas to strengthen your STAR responses:</p>
                                    <ul class="improvements-list" id="improvementsList"></ul>
                                </div>
                            </div>

                            <!-- Recommendations Section -->
                            <div class="feedback-card">
                                <div class="feedback-card-header">
                                    <span class="feedback-card-icon">üí°</span>
                                    <h3 class="feedback-card-title">Recommendations for You</h3>
                                </div>
                                <div class="feedback-card-content">
                                    <p class="section-intro">Here's how you can improve for your next interview:</p>
                                    <ul class="recommendations-list" id="recommendationsList"></ul>
                                </div>
                            </div>

                            <!-- Summary Section -->
                            <div class="feedback-card summary-card">
                                <div class="feedback-card-header">
                                    <span class="feedback-card-icon">üìÑ</span>
                                    <h3 class="feedback-card-title">Your Interview Summary</h3>
                                </div>
                                <div class="feedback-card-content">
                                    <div class="summary-content">
                                        <p id="feedbackSummary"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="interview-actions" style="margin-top: 40px;">
                                <button class="btn btn-primary" onclick="window.location.href='index.html'">Back to Dashboard</button>
                                <button class="btn btn-secondary" id="restartInterviewBtn">Start New Interview</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2026 Skill Capital AI MockMate</p>
        </footer>
    </div>

    <!-- Modern Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
            </div>
            <div class="modal-body">
                <p class="modal-message" id="modalMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="modalCancelBtn">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Yes, End Interview</button>
            </div>
        </div>
    </div>

    <!-- Load API configuration first -->
    <script src="api-config.js"></script>
    <script>

        // State
        let currentUserId = null;
        let interviewSessionId = null;
        let conversationHistory = [];
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentQuestion = null;
        let interviewActive = false;
        let currentAudio = null;
        let isAudioPlaying = false;
        
        // Loading state management
        let isLoading = {
            submitAnswer: false,
            getNextQuestion: false
        };
        
        // Stop and destroy any currently playing audio
        function stopCurrentAudio() {
            if (currentAudio) {
                console.log('[TECHNICAL INTERVIEW] Stopping current audio playback');
                try {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    // Clean up blob URL if it exists
                    if (currentAudio.src && currentAudio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(currentAudio.src);
                    }
                } catch (e) {
                    console.warn('[TECHNICAL INTERVIEW] Error stopping audio:', e);
                }
                currentAudio = null;
                isAudioPlaying = false;
            }
        }

        function setLoadingState(key, value) {
            isLoading[key] = value;
        }

        // Get current user
        async function getCurrentUser() {
            try {
                const storedUserId = localStorage.getItem('user_id') || 
                                    sessionStorage.getItem('resume_user_id') || 
                                    window.CURRENT_USER_ID;
                if (storedUserId) {
                    currentUserId = storedUserId;
                    window.CURRENT_USER_ID = storedUserId;
                    return { user_id: storedUserId };
                }
                
                const res = await fetch(`${getApiBase()}/api/profile/current`);
                if (!res.ok) {
                    throw new Error(`Failed to get current user: ${res.status}`);
                }
                const user = await res.json();
                currentUserId = user.user_id;
                
                if (currentUserId) {
                    localStorage.setItem('user_id', currentUserId);
                    sessionStorage.setItem('resume_user_id', currentUserId);
                    window.CURRENT_USER_ID = currentUserId;
                }
                
                return user;
            } catch (e) {
                console.error('Error getting current user:', e);
                const fallbackUserId = localStorage.getItem('user_id') || 
                                       sessionStorage.getItem('resume_user_id') || 
                                       window.CURRENT_USER_ID;
                if (fallbackUserId) {
                    currentUserId = fallbackUserId;
                    window.CURRENT_USER_ID = fallbackUserId;
                    return { user_id: fallbackUserId };
                }
                throw new Error('No authenticated user found. Please ensure you have uploaded a resume and have a valid user profile.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        async function init() {
            try {
                // Get current user first
                await getCurrentUser();
                
                // Setup event listeners
                setupEventListeners();

                // Start interview
                await startInterview();
            } catch (e) {
                console.error('Initialization failed:', e);
                document.body.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <h2 style="color: #c62828;">Error</h2>
                        <p>${e.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px;">Retry</button>
                    </div>
                `;
            }
        }

        function setupEventListeners() {
            document.getElementById('voiceButton').addEventListener('click', toggleRecording);
            document.getElementById('endInterviewBtn').addEventListener('click', endInterview);
        }

        async function startInterview() {
            try {
                // Ensure we have current user
                if (!currentUserId) {
                    await getCurrentUser();
                }
                
                // Validate userId is available
                if (!currentUserId) {
                    throw new Error('userId is not defined. Please ensure you have uploaded a resume and have a valid user profile.');
                }
                
                const response = await fetch(`${getApiBase()}/api/interview/star/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to start interview: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                interviewSessionId = data.session_id;
                interviewActive = true;
                conversationHistory = [];  // Start with empty history (like HR/STAR)

                // Hide loading, show interview
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('interviewInterface').classList.remove('hidden');

                // Update status
                const statusEl = document.getElementById('interviewStatus');
                if (statusEl) {
                    statusEl.textContent = 'Interview Active';
                    statusEl.classList.add('active');
                }

                // Clear container and prepare for messages
                const container = document.getElementById('conversationContainer');
                if (container) {
                    container.innerHTML = '';
                }

                // ‚úÖ CONVERSATIONAL FLOW: Display first question if available (like HR/STAR interviews)
                if (data.question) {
                    currentQuestion = data.question;
                    conversationHistory.push({
                        role: 'ai',
                        content: data.question,
                        audio_url: data.audio_url
                    });
                    // Display question with audio URL
                    displayMessage('ai', data.question, data.audio_url);
                    
                    // Play audio if available
                    if (data.audio_url) {
                        setTimeout(() => {
                            playAudio(data.audio_url).catch(err => {
                                // Audio playback failed, manual play button will be shown
                            });
                        }, 100);
                    } else {
                        console.error('[TECHNICAL INTERVIEW] ‚ùå No audio_url received for first question');
                    }
                } else {
                    showError('No question received. Please try again.');
                }

            } catch (error) {
                console.error('[INTERVIEW] Start error:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="error-message">
                        <h3>Failed to Start Interview</h3>
                        <p>${error.message || 'Please ensure you have uploaded a resume with behavioral examples.'}</p>
                        <button class="btn btn-primary" onclick="window.location.href='star-interview.html'" style="margin-top: 15px;">
                            Go Back
                        </button>
                    </div>
                `;
            }
        }

        // Voice recording functions
        async function toggleRecording() {
            if (!interviewActive) return;
            if (isAudioPlaying) {
                document.getElementById('voiceStatus').textContent = 'Please wait for the question to finish...';
                return;
            }
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processAudioAnswer(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                document.getElementById('voiceButton').classList.add('recording');
                document.getElementById('voiceStatus').textContent = 'Recording... Click again to stop';
            } catch (error) {
                console.error('Error accessing microphone:', error);
                const errorMsg = 'Microphone access denied. Please allow microphone access and try again.';
                showError(errorMsg);
                alert(errorMsg);
                document.getElementById('voiceStatus').textContent = 'Microphone access required. Please allow access and try again.';
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('voiceButton').classList.remove('recording');
                document.getElementById('voiceStatus').textContent = 'Processing your answer...';
            }
        }

        // No-answer detection (simplified version)
        function detectNoAnswer(sttText) {
            if (!sttText || !sttText.trim()) {
                return { isNoAnswer: true, reason: 'empty_or_whitespace' };
            }
            const trimmed = sttText.trim();
            if (trimmed.length < 3) {
                return { isNoAnswer: true, reason: `too_short: ${trimmed}` };
            }
            return { isNoAnswer: false, reason: null };
        }

        async function processAudioAnswer(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const sttResponse = await fetch(`${getApiBase()}/api/interview/speech-to-text`, {
                    method: 'POST',
                    body: formData
                });

                if (!sttResponse.ok) {
                    throw new Error(`STT API failed with status: ${sttResponse.status}`);
                }

                const sttData = await sttResponse.json();
                const rawUserAnswer = sttData.text || '';
                
                const noAnswerCheck = detectNoAnswer(rawUserAnswer);
                let userAnswer;
                if (noAnswerCheck.isNoAnswer) {
                    userAnswer = 'No Answer';
                } else {
                    userAnswer = rawUserAnswer.trim();
                }

                displayMessage('user', userAnswer);
                await submitAnswer(userAnswer);

            } catch (error) {
                console.error('Process audio error:', error);
                const userAnswer = 'No Answer';
                displayMessage('user', userAnswer);
                await submitAnswer(userAnswer);
            }
        }

        async function submitAnswer(answer) {
            if (!answer || (!answer.trim() && answer !== 'No Answer')) {
                showError('I could not hear your answer. Please speak again.');
                return;
            }

            if (!interviewSessionId || !currentQuestion) {
                showError('No active interview session or question');
                return;
            }

            if (isLoading.submitAnswer) {
                console.warn('[SUBMIT ANSWER] Submit answer already in progress, ignoring duplicate call');
                return;
            }

            try {
                setLoadingState('submitAnswer', true);
                
                const response = await fetch(`${getApiBase()}/api/interview/star/${interviewSessionId}/submit-answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: currentQuestion,
                        answer: answer,
                        response_time: null
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to submit answer: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                conversationHistory.push({
                    role: 'user',
                    content: answer
                });

                // Display AI response if any
                if (data.ai_response) {
                    conversationHistory.push({
                        role: 'ai',
                        content: data.ai_response,
                        audio_url: data.audio_url
                    });
                    displayMessage('ai', data.ai_response, data.audio_url);
                    
                    if (data.audio_url) {
                        await playAudio(data.audio_url).catch(err => {
                            console.warn('[TECHNICAL INTERVIEW] Audio playback failed for feedback:', err);
                        });
                    }
                }

                // Check if interview is complete
                const aiQuestionsCount = conversationHistory.filter(m => m.role === 'ai').length;
                if (data.interview_completed || aiQuestionsCount >= 10) {
                    console.log(`[SUBMIT ANSWER] Interview completed: ${aiQuestionsCount} questions asked`);
                    await completeInterview();
                } else if (!isLoading.getNextQuestion) {
                    await getNextSTARQuestion(answer);
                } else {
                    console.warn('[SUBMIT ANSWER] getNextQuestion already in progress, ignoring duplicate call');
                }

                document.getElementById('voiceStatus').textContent = 'Click the microphone to record your answer';

            } catch (error) {
                console.error('[SUBMIT ANSWER] Error:', error);
                showError(error.message || 'Failed to submit answer. Please try again.');
                document.getElementById('voiceStatus').textContent = 'Error submitting answer. Click the microphone to try again.';
            } finally {
                setLoadingState('submitAnswer', false);
            }
        }

        async function getNextSTARQuestion(userAnswer = null) {
            if (!interviewSessionId) {
                showError('No interview session found. Please start the interview again.');
                return;
            }

            if (isLoading.getNextQuestion) {
                console.warn('[SUBMIT ANSWER] getNextQuestion already in progress, ignoring duplicate call');
                return;
            }

            try {
                setLoadingState('getNextQuestion', true);
                
                const loadingMsg = document.getElementById('loadingMessage');
                if (loadingMsg) {
                    loadingMsg.classList.add('hidden');
                }
                
                const requestBody = {};
                if (userAnswer) {
                    requestBody.user_answer = userAnswer;
                }
                
                const response = await fetch(`${getApiBase()}/api/interview/star/${interviewSessionId}/next-question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Backend error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                if (data.interview_completed) {
                    await completeInterview();
                    return;
                }
                
                const nextQuestion = data.question;
                const audioUrl = data.audio_url || data.audioUrl;
                
                if (!nextQuestion) {
                    throw new Error('No question received from backend');
                }
                
                currentQuestion = nextQuestion;
                conversationHistory.push({
                    role: 'ai',
                    content: nextQuestion,
                    audio_url: audioUrl
                });
                
                displayMessage('ai', nextQuestion, audioUrl);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                if (audioUrl && audioUrl.trim()) {
                    await playAudio(audioUrl).catch(err => {
                    });
                } else if (nextQuestion) {
                    // Fallback: generate TTS from question text
                    await playAudio(nextQuestion).catch(err => {
                    });
                }

            } catch (error) {
                console.error('[SUBMIT ANSWER] Submit answer error:', error);
                showError(`Failed to get question: ${error.message || 'Please try again.'}`);
                document.getElementById('voiceStatus').textContent = 'Error occurred. Please try recording again or start a new interview.';
            } finally {
                setLoadingState('getNextQuestion', false);
            }
        }

        async function completeInterview() {
            interviewActive = false;
            document.getElementById('interviewInterface').classList.add('hidden');
            document.getElementById('feedbackSection').classList.remove('hidden');
            await generateFeedback();
        }

        // Feedback generation (STAR-specific)
        function setScoreBadge(score) {
            const scoreBadgeEl = document.getElementById('scoreBadge');
            if (scoreBadgeEl) {
                const numericScore = typeof score === 'string' ? parseInt(score) : Math.round(score);
                if (numericScore >= 80) {
                    scoreBadgeEl.textContent = '‚≠ê‚≠ê‚≠ê Strong';
                } else if (numericScore >= 60) {
                    scoreBadgeEl.textContent = '‚≠ê‚≠ê Improving';
                } else {
                    scoreBadgeEl.textContent = '‚≠ê Beginner';
                }
            }
        }

        function setScoreMessage(score) {
            const scoreMessageEl = document.getElementById('scoreMessage');
            if (scoreMessageEl) {
                const numericScore = typeof score === 'string' ? parseInt(score) : Math.round(score);
                if (numericScore >= 80) {
                    scoreMessageEl.textContent = 'Outstanding performance! You demonstrated strong STAR method skills.';
                } else if (numericScore >= 60) {
                    scoreMessageEl.textContent = 'Good work! With more practice, you can improve your STAR responses.';
                } else {
                    scoreMessageEl.textContent = 'Keep practicing to improve your STAR responses!';
                }
            }
        }

        function displayPerformanceBreakdown(feedback) {
            const components = [
                { key: 'situation_score', id: 'situation', label: 'Situation' },
                { key: 'task_score', id: 'task', label: 'Task' },
                { key: 'action_score', id: 'action', label: 'Action' },
                { key: 'result_score', id: 'result', label: 'Result' },
                { key: 'star_structure_score', id: 'structure', label: 'STAR Structure' }
            ];
            
            components.forEach(component => {
                const score = Math.round(feedback[component.key] || 0);
                const scoreEl = document.getElementById(component.id + 'Score');
                const fillEl = document.getElementById(component.id + 'Fill');
                
                if (scoreEl) scoreEl.textContent = score;
                if (fillEl) {
                    setTimeout(() => {
                        fillEl.style.width = score + '%';
                    }, 100);
                }
            });
        }

        async function generateFeedback() {
            if (!interviewSessionId) {
                generateBasicFeedback();
                return;
            }

            if (isLoading.generateFeedback) {
                console.warn('[FEEDBACK] Generate feedback already in progress, ignoring duplicate call');
                return;
            }

            try {
                setLoadingState('generateFeedback', true);
                
                const response = await fetch(`${getApiBase()}/api/interview/star/${interviewSessionId}/feedback`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    generateBasicFeedback();
                    return;
                }

                const feedback = await response.json();
                if (!feedback) {
                    generateBasicFeedback();
                    return;
                }

                
                const overallScore = Math.round(feedback.overall_score || 0);
                document.getElementById('overallScore').textContent = overallScore;
                setScoreBadge(overallScore);
                setScoreMessage(overallScore);
                
                const welcomeTextEl = document.getElementById('welcomeText');
                if (welcomeTextEl) {
                    if (overallScore >= 80) {
                        welcomeTextEl.textContent = 'Outstanding work! You completed your STAR interview with excellent performance. Here\'s your personalized breakdown.';
                    } else if (overallScore >= 60) {
                        welcomeTextEl.textContent = 'Great job completing your STAR interview! Here\'s your personalized performance report to help you improve.';
                    } else {
                        welcomeTextEl.textContent = 'Thank you for completing your STAR interview! Here\'s your personalized feedback to help you improve.';
                    }
                }
                
                const questionCount = feedback.question_count || 0;
                const userMessages = conversationHistory.filter(m => m.role === 'user');
                const answeredCount = userMessages.length;
                const participationRate = questionCount > 0 ? Math.round((answeredCount / questionCount) * 100) : 0;
                
                const questionsAnsweredEl = document.getElementById('questionsAnswered');
                if (questionsAnsweredEl) questionsAnsweredEl.textContent = answeredCount;
                
                const participationRateEl = document.getElementById('participationRate');
                if (participationRateEl) participationRateEl.textContent = participationRate + '%';
                
                const participationNoteEl = document.getElementById('participationNote');
                if (participationNoteEl) {
                    if (participationRate >= 80) {
                        participationNoteEl.textContent = 'Excellent! You actively engaged with all questions throughout the interview.';
                    } else if (participationRate >= 60) {
                        participationNoteEl.textContent = 'Good participation! You answered most of the questions asked.';
                    } else {
                        participationNoteEl.textContent = 'Try to answer more questions in your next interview to get better feedback.';
                    }
                }
                
                displayPerformanceBreakdown(feedback);
                
                const strengthsList = document.getElementById('strengthsList');
                if (strengthsList) {
                    const strengths = feedback.strengths || [];
                    strengthsList.innerHTML = strengths.length > 0 
                        ? strengths.map(s => `<li>${s}</li>`).join('')
                        : '<li>Keep practicing to build your strengths!</li>';
                }

                const improvementsList = document.getElementById('improvementsList');
                if (improvementsList) {
                    const improvements = feedback.areas_for_improvement || [];
                    improvementsList.innerHTML = improvements.length > 0
                        ? improvements.map(a => `<li>${a}</li>`).join('')
                        : '<li>Great job! Continue refining your STAR responses.</li>';
                }

                const recommendationsList = document.getElementById('recommendationsList');
                if (recommendationsList) {
                    const recommendations = feedback.recommendations || [];
                    recommendationsList.innerHTML = recommendations.length > 0
                        ? recommendations.map(r => `<li>${r}</li>`).join('')
                        : '<li>Keep practicing your STAR method responses!</li>';
                }

                const feedbackSummaryEl = document.getElementById('feedbackSummary');
                if (feedbackSummaryEl) {
                    feedbackSummaryEl.textContent = feedback.feedback_summary || 'No summary available.';
                }

                const feedbackLoading = document.getElementById('feedbackLoading');
                const feedbackContent = document.getElementById('feedbackContent');
                if (feedbackLoading) feedbackLoading.classList.add('hidden');
                if (feedbackContent) feedbackContent.classList.remove('hidden');

            } catch (error) {
                console.error('[FEEDBACK] Error:', error);
                generateBasicFeedback();
            } finally {
                setLoadingState('generateFeedback', false);
            }
        }

        function generateBasicFeedback() {
            const userMessages = conversationHistory.filter(m => m.role === 'user');
            const answerCount = userMessages.length;
            const validAnswers = userMessages.filter(m => {
                const text = m.content || '';
                return text.trim() && text.trim() !== 'No Answer' && text.trim().split(/\s+/).length >= 3;
            });
            const validAnswerCount = validAnswers.length;

            if (validAnswerCount === 0) {
                document.getElementById('overallScore').textContent = '0';
                setScoreBadge(0);
                setScoreMessage(0);
                const questionsAnsweredEl = document.getElementById('questionsAnswered');
                if (questionsAnsweredEl) questionsAnsweredEl.textContent = '0';
                const participationRateEl = document.getElementById('participationRate');
                if (participationRateEl) participationRateEl.textContent = '0%';
                displayPerformanceBreakdown({
                    situation_score: 0, task_score: 0, action_score: 0,
                    result_score: 0, star_structure_score: 0
                });
                document.getElementById('strengthsList').innerHTML = '<li>No valid response detected.</li>';
                document.getElementById('improvementsList').innerHTML = '<li>Please provide spoken answers to receive accurate STAR feedback.</li>';
                document.getElementById('recommendationsList').innerHTML = '<li>Try answering all STAR questions with clear Situation, Task, Action, and Result.</li>';
                document.getElementById('feedbackSummary').textContent = 'Interview ended early with no valid responses.';
                document.getElementById('feedbackLoading').classList.add('hidden');
                document.getElementById('feedbackContent').classList.remove('hidden');
                return;
            }

            const totalWords = validAnswers.reduce((sum, m) => {
                return sum + (m.content || '').split(/\s+/).filter(Boolean).length;
            }, 0);
            const avgWords = validAnswerCount > 0 ? totalWords / validAnswerCount : 0;

            let score = 0;
            if (validAnswerCount >= 4) score += 20;
            else if (validAnswerCount >= 2) score += 10;
            if (avgWords >= 50) score += 25;
            else if (avgWords >= 30) score += 18;
            else if (avgWords >= 15) score += 8;
            score = Math.max(0, Math.min(85, Math.round(score)));

            const strengths = [`You provided ${validAnswerCount} STAR example${validAnswerCount > 1 ? 's' : ''} during the interview.`];
            const improvements = [];
            const recommendations = [];

            if (avgWords >= 35) {
                strengths.push('Your answers had reasonable detail and context for behavioral situations.');
            } else if (avgWords >= 15) {
                improvements.push('Some answers were quite brief; adding more detail for Situation, Task, Action, and Result will make them stronger.');
            } else {
                improvements.push('Answers were very short; try expanding each story with more context, actions, and results.');
            }

            improvements.push('Make sure each answer clearly covers all four STAR parts: Situation, Task, Action, and Result.');
            recommendations.push('Write down 3‚Äì5 STAR stories and practice telling them out loud with clear outcomes and metrics.');

            document.getElementById('overallScore').textContent = String(score);
            setScoreBadge(score);
            setScoreMessage(score);
            
            const questionsAnsweredEl = document.getElementById('questionsAnswered');
            if (questionsAnsweredEl) questionsAnsweredEl.textContent = validAnswerCount;
            const participationRateEl = document.getElementById('participationRate');
            if (participationRateEl) {
                const rate = answerCount > 0 ? Math.round((validAnswerCount / answerCount) * 100) : 0;
                participationRateEl.textContent = rate + '%';
            }
            
            displayPerformanceBreakdown({
                situation_score: score, task_score: score, action_score: score,
                result_score: score, star_structure_score: score
            });
            
            document.getElementById('strengthsList').innerHTML = strengths.map(s => `<li>${s}</li>`).join('');
            document.getElementById('improvementsList').innerHTML = improvements.map(a => `<li>${a}</li>`).join('');
            document.getElementById('recommendationsList').innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
            document.getElementById('feedbackSummary').textContent = 'We could not load the full AI report, so this quick summary is based on how many STAR examples you shared and how detailed they were. For a richer, fully personalized report, please try the interview again when your connection is stable.';

            document.getElementById('feedbackLoading').classList.add('hidden');
            document.getElementById('feedbackContent').classList.remove('hidden');
        }

        function displayMessage(role, content, audioUrl = null) {
            const container = document.getElementById('conversationContainer');
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            const header = role === 'ai' ? 'AI Interviewer' : 'You';
            messageDiv.innerHTML = `
                <div class="message-header">${header}</div>
                <div class="message-content">${content}</div>
                ${audioUrl ? `<audio class="audio-player" controls src="${audioUrl}"></audio>` : ''}
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function playAudio(textOrUrl, retryCount = 0) {
            const MAX_RETRIES = 2;
            if (!textOrUrl) {
                return;
            }
            
            // Stop any currently playing audio before starting a new one
            stopCurrentAudio();
            
            try {
                let text = textOrUrl;
                
                // If it's a URL, extract text from it or use it directly
                if (textOrUrl.startsWith('http')) {
                    // Try to extract text from query parameter
                    try {
                        const url = new URL(textOrUrl);
                        
                        // Detect localhost/127.0.0.1 URLs and regenerate audio
                        const isLocalhost = url.hostname === 'localhost' || url.hostname === '127.0.0.1';
                        const textParam = url.searchParams.get('text');
                        
                        if (isLocalhost && textParam) {
                            // Backend returned localhost URL - extract text and regenerate using correct endpoint
                            console.warn('[TTS] Detected localhost URL from backend, regenerating audio with correct endpoint:', textOrUrl);
                            text = decodeURIComponent(textParam);
                            // Fall through to TTS generation below
                        } else if (textParam) {
                            // Valid URL with text parameter - extract text
                            text = decodeURIComponent(textParam);
                        } else {
                            // If it's a direct audio URL (not localhost), try to play it
                            if (!isLocalhost) {
                                const audio = new Audio(textOrUrl);
                                currentAudio = audio;
                                isAudioPlaying = true;
                                
                                // Wait for audio to finish playing before returning
                                const audioPlayPromise = new Promise((resolve, reject) => {
                                    audio.onended = () => {
                                        document.getElementById('voiceStatus').textContent = 'Click the microphone to start recording';
                                        currentAudio = null;
                                        isAudioPlaying = false;
                                        resolve();
                                    };
                                    audio.onerror = (e) => {
                                        console.error('[TTS] Direct audio URL playback failed:', e);
                                        currentAudio = null;
                                        isAudioPlaying = false;
                                        reject(e);
                                    };
                                });
                                
                                await audio.play();
                                await audioPlayPromise;
                                return;
                            }
                        }
                    } catch (e) {
                        // Not a valid URL, treat as text
                        text = textOrUrl;
                    }
                }
                
                if (!text || text.trim().length === 0) {
                    return;
                }
                
                // Show loading indicator
                document.getElementById('voiceStatus').textContent = 'Generating audio...';
                
                // Use TECH_BACKEND_URL for audio generation (supports separate backend deployment)
                const techBackendUrl = typeof getTechBackendUrl !== 'undefined' ? getTechBackendUrl() : getApiBase();
                const audioApiUrl = `${techBackendUrl}/api/interview/generate-audio`;
                
                const response = await fetch(audioApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text.trim() })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[TTS] API error:', response.status, errorText);
                    
                    // Retry on server errors (5xx) or service unavailable (503)
                    if ((response.status >= 500 || response.status === 503) && retryCount < MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                        return playAudio(textOrUrl, retryCount + 1);
                    }
                    
                    throw new Error(`TTS failed: ${response.status} - ${errorText}`);
                }
                
                // Get audio blob
                const audioBlob = await response.blob();
                
                if (audioBlob.size === 0) {
                    throw new Error('Empty audio blob received from server');
                }
                
                const audioUrl_obj = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl_obj);
                currentAudio = audio;
                isAudioPlaying = true;
                
                // Set up event handlers before playing
                const audioPlayPromise = new Promise((resolve, reject) => {
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl_obj);
                        document.getElementById('voiceStatus').textContent = 'Click the microphone to start recording';
                        currentAudio = null;
                        isAudioPlaying = false;
                        resolve();
                    };
                    
                    audio.onerror = (error) => {
                        console.error('[TTS] Audio playback error:', error);
                        URL.revokeObjectURL(audioUrl_obj);
                        document.getElementById('voiceStatus').textContent = 'Audio playback failed. Question is displayed above.';
                        currentAudio = null;
                        isAudioPlaying = false;
                        reject(error);
                    };
                });
                
                audio.onloadstart = () => {
                    document.getElementById('voiceStatus').textContent = 'Loading audio...';
                };
                
                audio.oncanplay = () => {
                    document.getElementById('voiceStatus').textContent = 'AI is speaking the question...';
                };
                
                // Play audio
                try {
                    await audio.play();
                    await audioPlayPromise;
                } catch (playError) {
                    console.error('[TTS] Error starting playback:', playError);
                    if (playError.name === 'NotAllowedError') {
                        document.getElementById('voiceStatus').textContent = 'Click anywhere to enable audio playback';
                        document.addEventListener('click', async function enableAudio() {
                            try {
                                await audio.play();
                                await audioPlayPromise;
                                document.removeEventListener('click', enableAudio);
                            } catch (e) {
                                console.error('[TTS] Still cannot play after interaction:', e);
                            }
                        }, { once: true });
                    } else {
                        throw playError;
                    }
                }
                
            } catch (error) {
                console.error('[TTS] Error in playAudio:', error);
                
                currentAudio = null;
                isAudioPlaying = false;
                
                // Retry on network errors
                if (retryCount < MAX_RETRIES && (error.message.includes('fetch') || error.message.includes('network'))) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                    return playAudio(textOrUrl, retryCount + 1);
                }
                
                document.getElementById('voiceStatus').textContent = 'Audio playback unavailable. Question is displayed above.';
            }
        }

        function showError(message) {
            const container = document.getElementById('conversationContainer');
            if (!container) {
                alert(message);
                return;
            }
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.appendChild(errorDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showConfirmation(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmationModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const cancelBtn = document.getElementById('modalCancelBtn');

                if (!modal || !modalTitle || !modalMessage || !confirmBtn || !cancelBtn) {
                    alert('Error: Modal elements not found. Please refresh the page.');
                    resolve(false);
                    return;
                }

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.classList.add('show');

                const handleConfirm = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    modal.classList.remove('show');
                    resolve(true);
                };

                const handleCancel = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    modal.classList.remove('show');
                    resolve(false);
                };

                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                const finalConfirmBtn = document.getElementById('modalConfirmBtn');
                const finalCancelBtn = document.getElementById('modalCancelBtn');
                finalConfirmBtn.addEventListener('click', handleConfirm, { once: true });
                finalCancelBtn.addEventListener('click', handleCancel, { once: true });
            });
        }

        async function endInterview() {
            const confirmed = await showConfirmation(
                'End STAR Interview?',
                'Are you sure you want to end your STAR Interview? Your progress will be saved.'
            );
            
            if (confirmed) {
                interviewActive = false;
                if (isRecording) {
                    stopRecording();
                }
                if (interviewSessionId) {
                    try {
                        await fetch(`${getApiBase()}/api/interview/star/${interviewSessionId}/end`, {
                            method: 'POST'
                        });
                    } catch (error) {
                        console.error('Error ending interview:', error);
                    }
                }
                await completeInterview();
            }
        }

        function setLoadingState(operation, loading) {
            isLoading[operation] = loading;
            // UI updates handled by individual functions
        }
    </script>
</body>
</html>
